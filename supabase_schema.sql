-- ==============================================================================
-- SCHEMA SUPABASE - MANU3D ULTIMATE (FRESH INSTALL)
-- Script à copier/coller dans le SQL Editor de Supabase
-- ==============================================================================

-- 1. CONFIGURATION DU SITE (Clé/Valeur)
CREATE TABLE IF NOT EXISTS site_config (
    key TEXT PRIMARY KEY,
    value TEXT,
    description TEXT
);
ALTER TABLE site_config ENABLE ROW LEVEL SECURITY;

-- 2. PRODUITS
CREATE TABLE IF NOT EXISTS products (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    title TEXT NOT NULL,
    category TEXT DEFAULT 'Figurine',
    price TEXT DEFAULT '0.00€',
    image TEXT,
    gallery TEXT[] DEFAULT '{}',
    description TEXT,
    tags TEXT[] DEFAULT '{}',
    is_new BOOLEAN DEFAULT false,
    active BOOLEAN DEFAULT true,
    stock INTEGER DEFAULT 5,
    weight_g INTEGER DEFAULT 100,
    creator_id BIGINT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
ALTER TABLE products ENABLE ROW LEVEL SECURITY;

-- 3. COMMANDES
CREATE TABLE IF NOT EXISTS orders (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    customer_name TEXT,
    customer_email TEXT,
    customer_phone TEXT,
    shipping_address TEXT,
    items JSONB, 
    total NUMERIC,
    shipping_method TEXT,
    payment_method TEXT,
    payment_id TEXT,
    status TEXT DEFAULT 'paid' -- pending, paid, shipped, delivered, cancelled
);
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;

-- 4. MÉTHODES D'EXPÉDITION
CREATE TABLE IF NOT EXISTS shipping_methods (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    base_price NUMERIC DEFAULT 0,
    price_per_kg NUMERIC DEFAULT 0,
    estimated_days TEXT,
    min_weight NUMERIC DEFAULT 0,
    max_weight NUMERIC DEFAULT 999999,
    is_pickup BOOLEAN DEFAULT false,
    active BOOLEAN DEFAULT true
);
ALTER TABLE shipping_methods ENABLE ROW LEVEL SECURITY;

-- 5. MATÉRIAUX D'IMPRESSION
CREATE TABLE IF NOT EXISTS printing_materials (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    name TEXT NOT NULL,
    type TEXT,
    density NUMERIC DEFAULT 1.24,
    cost_per_gram NUMERIC DEFAULT 0.05,
    color_hex TEXT DEFAULT 'FFFFFF',
    active BOOLEAN DEFAULT true
);
ALTER TABLE printing_materials ENABLE ROW LEVEL SECURITY;

-- 6. COUPONS
CREATE TABLE IF NOT EXISTS coupons (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    code TEXT UNIQUE NOT NULL,
    discount_type TEXT DEFAULT 'percent',
    value NUMERIC NOT NULL,
    active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
ALTER TABLE coupons ENABLE ROW LEVEL SECURITY;

-- 7. BLOG / ARTICLES
CREATE TABLE IF NOT EXISTS articles (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    title TEXT NOT NULL,
    excerpt TEXT,
    category TEXT DEFAULT 'News',
    image TEXT,
    author TEXT DEFAULT 'Manu',
    read_time TEXT DEFAULT '3 min',
    date TIMESTAMPTZ DEFAULT NOW(),
    active BOOLEAN DEFAULT true
);
ALTER TABLE articles ENABLE ROW LEVEL SECURITY;

-- 8. PARTENAIRES & AVIS & PORTFOLIO
CREATE TABLE IF NOT EXISTS partners (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name TEXT UNIQUE,
    logo_url TEXT,
    description TEXT,
    url TEXT,
    display_order INTEGER DEFAULT 0
);
ALTER TABLE partners ENABLE ROW LEVEL SECURITY;

CREATE TABLE IF NOT EXISTS reviews (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name TEXT,
    role TEXT,
    rating INTEGER DEFAULT 5,
    text TEXT,
    item_purchased TEXT,
    display_date TEXT
);
ALTER TABLE reviews ENABLE ROW LEVEL SECURITY;

CREATE TABLE IF NOT EXISTS portfolio (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    title TEXT,
    description TEXT,
    image TEXT
);
ALTER TABLE portfolio ENABLE ROW LEVEL SECURITY;

CREATE TABLE IF NOT EXISTS creators (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name TEXT,
    bio TEXT,
    avatar_url TEXT,
    banner_url TEXT,
    website_url TEXT,
    social_instagram TEXT
);
ALTER TABLE creators ENABLE ROW LEVEL SECURITY;

-- 9. DEMANDES PROJET
CREATE TABLE IF NOT EXISTS project_requests (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    customer_name TEXT,
    customer_email TEXT,
    project_type TEXT,
    description TEXT,
    file_url TEXT,
    is_urgent BOOLEAN DEFAULT false,
    status TEXT DEFAULT 'pending'
);
ALTER TABLE project_requests ENABLE ROW LEVEL SECURITY;

-- 10. NEWSLETTER
CREATE TABLE IF NOT EXISTS newsletter_subscribers (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    email TEXT UNIQUE NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
ALTER TABLE newsletter_subscribers ENABLE ROW LEVEL SECURITY;

-- ==============================================================================
-- POLITIQUES DE SÉCURITÉ (RLS POLICIES)
-- ==============================================================================

DO $$ BEGIN
  -- Lecture Publique
  CREATE POLICY "Public Read Site Config" ON site_config FOR SELECT USING (true);
  CREATE POLICY "Public Read Products" ON products FOR SELECT USING (true);
  CREATE POLICY "Public Read Shipping" ON shipping_methods FOR SELECT USING (true);
  CREATE POLICY "Public Read Materials" ON printing_materials FOR SELECT USING (true);
  CREATE POLICY "Public Read Coupons" ON coupons FOR SELECT USING (true);
  CREATE POLICY "Public Read Articles" ON articles FOR SELECT USING (true);
  CREATE POLICY "Public Read Partners" ON partners FOR SELECT USING (true);
  CREATE POLICY "Public Read Reviews" ON reviews FOR SELECT USING (true);
  CREATE POLICY "Public Read Portfolio" ON portfolio FOR SELECT USING (true);
  CREATE POLICY "Public Read Creators" ON creators FOR SELECT USING (true);
  
  -- Écriture Admin (Autoriser tout le monde à écrire si on a la clé API, la sécu est gérée par le mot de passe Admin de l'app React)
  CREATE POLICY "Admin All Site Config" ON site_config FOR ALL USING (true) WITH CHECK (true);
  CREATE POLICY "Admin All Products" ON products FOR ALL USING (true) WITH CHECK (true);
  CREATE POLICY "Admin All Articles" ON articles FOR ALL USING (true) WITH CHECK (true);
  CREATE POLICY "Admin All Coupons" ON coupons FOR ALL USING (true) WITH CHECK (true);
  CREATE POLICY "Admin All Shipping" ON shipping_methods FOR ALL USING (true) WITH CHECK (true);
  CREATE POLICY "Admin All Materials" ON printing_materials FOR ALL USING (true) WITH CHECK (true);
  CREATE POLICY "Admin All Partners" ON partners FOR ALL USING (true) WITH CHECK (true);
  CREATE POLICY "Admin All Reviews" ON reviews FOR ALL USING (true) WITH CHECK (true);
  CREATE POLICY "Admin All Portfolio" ON portfolio FOR ALL USING (true) WITH CHECK (true);
  CREATE POLICY "Admin All Creators" ON creators FOR ALL USING (true) WITH CHECK (true);

  -- Commandes & Intéractions Clients
  CREATE POLICY "Public Create Orders" ON orders FOR INSERT WITH CHECK (true);
  CREATE POLICY "Admin Manage Orders" ON orders FOR SELECT USING (true);
  CREATE POLICY "Admin Update Orders" ON orders FOR UPDATE USING (true);
  
  CREATE POLICY "Public Create Requests" ON project_requests FOR INSERT WITH CHECK (true);
  CREATE POLICY "Admin Manage Requests" ON project_requests FOR ALL USING (true);

  CREATE POLICY "Public Subscribe" ON newsletter_subscribers FOR INSERT WITH CHECK (true);
  CREATE POLICY "Admin View Subs" ON newsletter_subscribers FOR SELECT USING (true);

EXCEPTION WHEN duplicate_object THEN NULL; END $$;